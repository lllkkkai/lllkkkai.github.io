---
layout: post
category: Design
---
## 没有计算机的时代怎么记账
在计算机出现之前，银行的记账主要依赖手工操作和物理账簿系统

### 1. **手工账簿系统**：
   - **主账簿（Ledger）**：银行使用大型纸质账簿记录所有账户的交易。每一笔存款、取款、转账等交易都会手工记录在账簿中。
   - **分类账（General Ledger）**：记录银行的总账目，包括资产、负债、收入和支出等。
   - **客户账（Customer Accounts）**：为每位客户单独开设账户，记录其存款和取款情况。

### 2. **复式记账法（Double-Entry Bookkeeping）**：
   - **原则**：每笔交易需要同时在借方和贷方记录，以保持账目平衡。
   - **示例**：客户存款时，银行会同时记录该客户的账户增加了存款金额，以及银行的现金账户也增加了相同金额。

### 3. **物理凭证和票据**：
   - **支票**：客户使用支票进行支付，银行根据支票信息手工调整账户余额。
   - **存折**：客户使用存折记录存款和取款，银行工作人员会手动更新存折中的余额。
   - **转账单**：客户填写转账单，银行工作人员根据单据手工调整相关账户的余额。

### 4. **审核和检查机制**：
   - **日终对账**：每天营业结束后，银行工作人员会对所有账簿进行对账，确保账目平衡。
   - **审计**：定期由内部或外部审计师检查账簿，确保记录的准确性和合规性。

### 5. **存储和管理**：
   - **档案室**：账簿和凭证存放在银行的档案室中，按日期和类别分类保管。
   - **防火防盗**：档案室通常配备防火防盗设施，确保重要财务数据的安全。

### 6. **人力资源**：
   - **出纳员**：负责日常现金收付和客户账户管理。
   - **会计**：负责账簿记录和财务报告。
   - **审核员**：负责对账和审计工作。

### 7. **局限性和挑战**：
   - **效率低下**：手工记账速度慢，容易出错。
   - **管理难度大**：随着业务规模扩大，账簿数量和复杂性增加，管理难度显著提高。
   - **安全性问题**：物理账簿容易遭受火灾、洪水等自然灾害的破坏，也可能被篡改或盗窃。

### 总结：
在没有计算机的时代，银行依赖手工账簿和物理凭证进行记账和管理。虽然这种方式的效率和准确性相对较低，但通过严格的制度和人力资源配置，银行仍然能够有效地管理财务和客户账户。

计算机出现之后，本质上是将物理账本的业务逻辑用计算机代码和硬件设备来实现了，即依赖中心化的第三方机构（银行）来***验证**和**记录**交易；

缺点：
1. 第三方机构信任问题（破产、跑路等风险）
2. 中心化系统的脆弱性（账本的丢失风险）
3. 高交易成本、跨境支付的低效（机构本身存在的成本）；

## 数字货币的问题

### 双花问题（Double Spending）
双花问题（Double Spending）是数字货币领域（实物货币不存在，因为纸币是实体的）的一个核心问题，简单来说，就是**一笔钱被花了两次**。这个问题在数字货币中尤其重要，因为数字货币本质上是一串数字代码，很容易被复制和重复使用。

区块链出现之前，解决双花问题的方法是通过中心化的机构（比如银行）来记录每一笔交易。银行会确保你账户里的钱只被使用一次，不会被重复使用。

### 区块链（Block Chain）
区块链是一种**去中心化**的**分布式**账本，数据以**链式**结构存储。每个区块包含一定数量的交易记录，并通过**加密技术**与前一个区块相连，形成一个**不可篡改**的链条。

## 区块包含的内容
交易（Transactions）：包含在当前区块中的所有交易。每个交易包含发送方和接收方的地址、交易金额、交易时间等信息。
前一个区块的哈希值（Previous Block Hash）：用于将当前区块与前一个区块连接，形成链式结构。
时间戳（Timestamp）：记录区块生成的时间。

#### 去中心化与分布式
与单个机构保存所有数据相比，区块链的每个节点都保存着全部交易记录，所有节点都会参与交易的验证和记录。没有一个节点可以单独控制整个网络。
#### 链式结构
每个区块会记录
#### UTXO
UTXO模型与账户余额模型比特币使用UTXO模型来管理资产，而传统金融系统通常使用账户余额模型。两者的区别如下：
（1）UTXO模型• 无账户余额：比特币中没有“账户余额”的概念，只有UTXO。• 交易是基于UTXO的：每次交易引用已有的UTXO，创建新的UTXO。• 隐私性更高：UTXO模型使得交易路径更难追踪，增加了隐私性。（2）账户余额模型• 有账户余额：传统金融系统中，每个账户有一个明确的余额。• 交易是基于账户的：从一个账户直接转账到另一个账户。• 隐私性较低：账户余额模型更容易追踪资金流向。


### 非对称加密（Asymmetric Encryption）
非对称加密是一种加密技术，它使用两个不同的密钥：**公钥**和**私钥**。这两个密钥在数学上是相关的，但无法从其中一个推导出另一个。

- **公钥**：可以公开分享，用于加密数据或验证签名。
- **私钥**：必须保密，用于解密数据或生成签名。

#### 特点：
1. **加密与解密**：用公钥加密的数据只能用对应的私钥解密，反之亦然。
2. **安全性**：由于私钥不需要共享，非对称加密在密钥管理上比对称加密更安全。
3. **性能**：非对称加密通常比对称加密慢，适合加密小量数据或用于密钥交换。

### 数字签名（Digital Signature）
数字签名是一种用于验证消息完整性和发送者身份的技术。它基于非对称加密，通常包括以下步骤：
1. **生成签名**：发送者使用自己的私钥对消息的哈希值进行加密，生成签名。
2. **验证签名**：接收者使用发送者的公钥解密签名，得到哈希值，并与自己计算的消息哈希值进行比对。

#### 特点：
1. **身份验证**：只有拥有私钥的发送者才能生成有效的签名，因此可以验证发送者的身份。
2. **完整性验证**：如果消息在传输过程中被篡改，哈希值将不匹配，签名验证将失败。
3. **不可否认性**：发送者不能否认自己发送了消息，因为只有他们拥有生成签名的私钥。

#### 联系：
- **技术基础**：数字签名基于非对称加密技术，使用公钥和私钥对。
- **安全性**：两者都依赖于非对称加密的安全性，确保只有持有私钥的人可以生成有效的签名或解密数据。

### 总结
非对称加密用于保护数据的隐私和安全性，而数字签名用于验证数据的来源和完整性。两者结合使用，可以构建一个安全、可信的数据传输和验证系统。

## 共识机制

### **1. 去中心化环境下的信任问题**
- **问题**：在去中心化系统中，没有一个中心化的机构（如银行）来验证和记录交易。如何确保所有参与者可以信任账本的准确性？
- **解决**：共识机制通过算法和规则，使所有参与者共同验证交易和达成一致，无需依赖中心化机构。

### **2. 防止恶意行为（如双花攻击）**
- **问题**：在分布式网络中，可能存在恶意节点试图篡改账本或进行双花攻击（同一笔资金被花费两次）。
- **解决**：共识机制通过验证和记录交易的顺序，确保交易的唯一性和不可篡改性，防止双花等攻击。

### **3. 数据一致性和同步**
- **问题**：在分布式网络中，不同节点的数据可能存在延迟或不一致。如何确保所有节点拥有相同的账本副本？
- **解决**：共识机制通过协调所有节点的行为，确保它们最终达成一致的账本状态，保证数据的全局一致性。

### **4. 激励机制和参与者协调**
- **问题**：在去中心化系统中，如何激励参与者（如矿工或验证者）诚实地维护网络？
- **解决**：共识机制通常设计激励机制（如区块奖励或交易手续费），鼓励参与者遵守规则并为网络贡献资源。

### **5. 性能与安全性的平衡**
- **问题**：如何在去中心化网络中实现高性能（如快速确认交易）的同时，确保网络安全性和去中心化程度？
- **解决**：不同的共识机制（如PoW、PoS、PBFT等）在性能、安全性和去中心化之间进行权衡，找到适合特定应用场景的平衡点。

### **常见共识机制及其特点**
- **PoW（工作量证明）**：通过计算哈希值验证交易，抗攻击能力强，但能耗高。
- **PoS（权益证明）**：根据持币量选择验证者，能耗低，但可能导致财富集中。
- **PBFT（拜占庭容错）**：适用于小规模网络，快速确认但扩展性差。
- **DPoS（委托权益证明）**：通过投票选出验证者，提高效率但去中心化程度较低。

## PoW
**PoW（Proof of Work，工作量证明）** 是区块链领域最早使用的共识机制之一，由比特币的创始人中本聪引入。它通过要求参与者完成一定的计算工作来验证交易和生成新区块，从而确保区块链网络的安全性和去中心化。以下是对 PoW 的详细讲解及其解决的问题。

---

### **PoW 的核心概念**

1. **工作量证明**：
   - PoW 要求矿工（节点）解决一个复杂的数学问题（通常是寻找特定条件的哈希值），以证明他们花费了计算资源。
   - 解决问题的过程被称为“挖矿”，成功解决问题的矿工有权利将新区块添加到区块链中。

2. **哈希函数**：
   - 矿工需要对区块头（包含交易数据、前一个区块的哈希值等信息）进行哈希运算。
   - 目标是找到一个满足特定条件的哈希值，例如以若干个 0 开头。

3. **挖矿难度**：
   - 网络的挖矿难度会根据全网算力动态调整，确保平均每 10 分钟（比特币为例）产生一个新区块。
   - 难度越高，需要更多的算力才能解决问题。

4. **奖励机制**：
   - 成功挖矿的矿工将获得区块奖励（如比特币的区块奖励）和交易手续费，作为激励。

---

### **PoW 的工作流程**
1. **打包交易**：
   - 矿工从交易池中选择交易，打包成一个候选区块。
2. **计算哈希值**：
   - 矿工对候选区块的区块头进行哈希运算，寻找满足条件的哈希值。
3. **验证与广播**：
   - 矿工找到符合条件的哈希值后，会将新区块广播给其他节点。
4. **接受与确认**：
   - 其他节点验证新区块的有效性（如哈希值、交易合法性），如果通过验证，则接受该区块并继续挖下一个区块。

---

### **PoW 解决的核心问题**

1. **去中心化环境下的共识问题**：
   - 在去中心化网络中，不存在中心化机构来验证交易。
   - PoW 通过计算工作确保所有节点对交易和账本状态达成一致，实现了分布式共识。

2. **防止双花问题**：
   - PoW 通过要求矿工花费资源来验证交易，增加了篡改交易记录的成本。
   - 要篡改交易记录，攻击者需要控制超过 50% 的全网算力（51% 攻击），这在实践中几乎不可能。

3. **激励参与者维护网络**：
   - PoW 通过区块奖励和交易手续费激励矿工诚实地维护网络，确保交易的合法性和安全性。

4. **抗攻击性**：
   - PoW 需要大量的计算资源，攻击者要发起攻击需要投入巨大的成本，这使得网络具有较高的抗攻击性。

---

### **PoW 的优点**
1. **去中心化**：
   - 任何人都可以参与挖矿，无需中心化机构管理。
2. **安全性**：
   - 需要极高的算力才能篡改数据，确保了网络的安全性。
3. **简单且经过验证**：
   - 比特币的成功证明了 PoW 的可行性和可靠性。

---

### **PoW 的缺点**
1. **能源消耗高**：
   - PoW 需要大量的电力进行挖矿，对环境造成负面影响。
2. **低效率**：
   - 比特币的平均出块时间为 10 分钟，交易确认速度较慢。
3. **中心化风险**：
   - 随着挖矿难度的增加，矿工倾向于加入矿池，可能导致算力集中在少数矿池中。

---

### **PoW 的具体实现（以比特币为例）**
1. **SHA-256 哈希算法**：
   - 比特币使用 SHA-256 哈希函数，矿工需要找到一个满足以下条件的哈希值：
     - `Hash(Block Header + Nonce) < Target`
   - `Nonce` 是一个随机数，矿工通过不断尝试不同的 `Nonce` 来找到符合条件的哈希值。
2. **难度调整**：
   - 比特币每 2016 个区块（约两周）调整一次难度，确保出块时间保持在 10 分钟左右。

---

### **总结**
PoW 是区块链领域最早的共识机制之一，通过计算工作实现去中心化环境下的共识，解决了双花问题、激励参与者和网络安全性等问题。尽管存在能源消耗高和效率低等缺点，PoW 仍然是一个经过验证的、可靠的共识机制，比特币的成功应用充分证明了其价值。

## 交易池
交易池（Mempool）是比特币网络中的一个**缓存区域**，用于临时存储尚未被打包进区块的交易。它是区块链网络中非常重要的一部分，负责管理待处理的交易。以下是交易池的本质及其工作原理的详细解释：

---

### **交易池的本质**
1. **临时存储区域**：
   - 交易池是一个分布式存储区域，每个全节点都会维护自己的交易池。
   - 它存储所有有效的、但尚未被打包进区块的交易。

2. **交易的中间状态**：
   - 交易池中的交易处于“未确认”状态。
   - 它们已经在网络中广播，但还需要等待矿工将其打包到区块中。

3. **动态更新的数据结构**：
   - 交易池会不断更新：
     - 新的有效交易会被添加到交易池中。
     - 已被打包到区块中的交易会从交易池中移除。
     - 超时未确认的交易会被清除。

---

### **交易池的工作流程**

#### **1. 交易的广播**
- 当用户发起一笔交易时，交易会被发送到一个或多个比特币节点。
- 收到交易的节点会验证交易的有效性（如签名、UTXO 等）。
- 如果交易有效，节点会将其广播给其他节点，并将交易加入自己的交易池。

#### **2. 矿工的选择**
- 矿工从交易池中选择交易打包到候选区块中。
- 矿工通常会优先选择手续费较高的交易，以最大化收益。

#### **3. 交易的确认**
- 矿工将交易打包进区块后，区块会被广播到整个网络。
- 其他节点验证区块的有效性，并将区块链接到区块链中。
- 一旦交易被包含在区块中，它就会被从交易池中移除。

#### **4. 交易的清除**
- 如果一笔交易长时间未被确认（例如手续费太低），节点可能会将其从交易池中清除。

---

### **交易信息的存储**

#### **1. 交易池中的存储**
- 在交易池中的交易信息以键值对的形式存储。
- 例如，交易 ID（TXID）作为键，交易数据（如输入、输出、签名等）作为值。

#### **2. 区块链中的存储**
- 一旦交易被打包进区块并被区块链确认，交易信息就会被永久存储在区块链中。
- 区块链是一个分布式的、不可篡改的账本，所有交易都被按顺序记录。

#### **3. 节点的本地存储**
- 每个节点会将自己的交易池存储在本地内存或磁盘中。
- 交易池的大小和存储时间取决于节点的配置和网络的拥堵情况。

---

### **如果交易是真实的，但未被塞入区块链**
1. **所有节点都会收到交易信息**：
   - 只要交易是有效的，它就会被广播到整个网络，所有节点都会将其加入到自己的交易池中。

2. **交易未被打包的可能原因**：
   - **手续费太低**：矿工优先打包高手续费的交易。
   - **网络拥堵**：交易池中有大量交易等待处理。
   - **交易超时**：交易长时间未被确认，可能被节点清除。

3. **交易的最终状态**：
   - 如果交易长时间未被确认，用户可以选择增加手续费重新发送交易。
   - 如果交易未被重新发送，它最终会被从交易池中清除。

---

### **总结**
交易池的本质是一个临时存储未确认交易的区域，它确保了交易的广播和筛选过程能够顺利进行。真实的交易会被所有节点接收并存储在各自的交易池中，但只有被矿工打包到区块中的交易才会被永久记录在区块链中。交易池的设计使得比特币网络能够在去中心化的环境中高效处理交易，同时保证数据的一致性和安全性。

## 以太坊

### **Gas 机制的必要性**
1. **防止资源滥用**：
   - 以太坊网络是一个去中心化平台，执行智能合约需要消耗计算资源、存储资源和带宽。
   - 如果没有 Gas 机制，恶意用户可能会通过无限循环或复杂计算耗尽网络资源，导致整个网络瘫痪。
   - Gas 机制通过为每项操作定价，限制了资源的使用。

2. **经济激励**：
   - 执行交易和智能合约需要矿工或验证者提供计算资源。
   - Gas 机制通过 Gas 费用（Gas Fee）激励矿工优先处理高价值交易，确保网络安全和高效运行。

3. **防止网络拥塞**：
   - 在高峰期，以太坊网络可能会出现拥堵。Gas 机制通过动态调整费用（如以太坊的 EIP-1559 机制），鼓励用户合理使用网络资源。

4. **复杂性与成本的平衡**：
   - 不同操作的复杂性不同，Gas 机制为每个操作指定了固定的计算成本（Gas Limit），确保复杂操作支付更多的费用。

---

### **Gas 机制的基本概念**
1. **Gas**：
   - Gas 是衡量计算和存储操作成本的单位，例如执行加法需要 3 Gas，存储数据需要 20,000 Gas。
2. **Gas Limit**：
   - Gas Limit 是用户愿意为交易支付的最大 Gas 数量。如果交易消耗的 Gas 超过 Gas Limit，交易会失败，但 Gas 费用仍会被扣除。
3. **Gas Price（Gas 单价）**：
   - Gas Price 是用户愿意为每个 Gas 支付的以太币（ETH）数量，用于激励矿工。
4. **Gas Fee（Gas 费用）**：
   - Gas Fee 是交易的费用，计算公式为：`Gas Fee = Gas Used * Gas Price`。
   - 在 EIP-1559 之后，Gas Fee 分为基础费（Base Fee）和矿工小费（Priority Fee）。

---

### **如何在后端服务中预估 Gas 费用**
在后端服务中预估 Gas 费用是确保用户体验和交易成功率的重要步骤。以下是常见的预估方法：

#### **1. 使用以太坊节点 API**
以太坊节点提供了接口来预估交易的 Gas 消耗：
- **`eth_estimateGas`**：
  - 发送模拟交易给节点，返回预估的 Gas 消耗量。
  - 示例（使用 Web3.js）：
    ```javascript
    const gasEstimate = await web3.eth.estimateGas({
        to: "0xRecipientAddress",
        from: "0xSenderAddress",
        data: "0xContractMethodData"
    });
    ```

#### **2. 查询当前 Gas Price**
- **`eth_gasPrice`**：
  - 返回当前网络的 Gas Price。
  - 示例：
    ```javascript
    const gasPrice = await web3.eth.getGasPrice();
    ```

#### **3. 使用 Gas Price 预测服务**
- 许多第三方服务（如 [GasStation](https://ethgasstation.info/) 或 [Etherscan Gas Tracker](https://etherscan.io/gastracker)）提供实时 Gas Price 预测。
- 这些服务基于历史数据和网络拥堵情况，推荐合理的 Gas Price。

#### **4. 结合 EIP-1559 机制**
在 EIP-1559 之后，Gas Fee 由基础费（Base Fee）和矿工小费（Priority Fee）组成：
- **基础费**：
  - 基础费由网络算法动态调整，可以通过区块头信息获取。
- **矿工小费**：
  - 由用户设置，用于激励矿工优先处理交易。
- 示例：
  ```javascript
  const block = await web3.eth.getBlock("latest");
  const baseFee = block.baseFeePerGas;
  const priorityFee = web3.utils.toWei("2", "gwei"); // 用户设置
  const maxFeePerGas = baseFee + priorityFee;
  ```

#### **5. 动态调整 Gas Limit**
- 对于复杂交易（如智能合约调用），建议设置较高的 Gas Limit 以防止交易失败。
- 可以通过 `eth_estimateGas` 获取预估的 Gas 消耗，并乘以一个安全系数（如 1.2）。

---

### **总结**
以太坊的 Gas 机制通过量化资源消耗和经济激励，确保了网络的安全性和高效性。在后端服务中，通过以太坊节点 API、第三方 Gas 预测服务和 EIP-1559 机制，可以准确预估 Gas 费用，为用户提供更好的交易体验。