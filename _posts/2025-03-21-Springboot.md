**Tomcat 线程池怎么接请求**
---

### 1. 大背景：Tomcat 的角色
- **Tomcat** 是一个 Web 服务器，Spring Boot 默认用它来跑你的应用。
- **线程池** 是 Tomcat 的“工人团队”，专门处理 HTTP 请求（比如浏览器访问 `/hello`）。
- **接请求** 是指 Tomcat 从网络接收请求，交给线程池里的线程去执行。

#### 通俗比喻
- 像一家饭店：
  - **请求**：客人点餐。
  - **Tomcat**：饭店老板，负责开门迎客。
  - **线程池**：服务员团队，接待和处理订单。

---

### 2. Tomcat 线程池接请求的流程
让我们一步步看，假设用户访问 `http://localhost:8080/api/hello`：

#### (1) 监听端口，接收请求
- **怎么做**：
  - Tomcat 启动时，在指定端口（默认 8080）监听网络连接。
  - 用 Java 的 `ServerSocket`，等着客户端（比如浏览器）发请求。
- **细节**：
  - 用户发 `GET /api/hello`，数据通过 TCP 传到 8080 端口。
  - Tomcat 的 **Acceptor**（一个内部线程）负责接收这个连接。
- **比喻**：
  - 饭店门口有个迎宾员（Acceptor），看到客人进来就喊“有新单”。

#### (2) 把请求扔给线程池
- **怎么做**：
  - Acceptor 接到请求后，不自己处理，而是交给线程池。
  - 线程池有个“任务调度器”（Executor），从池子里挑一个空闲线程。
- **细节**：
  - Tomcat 默认线程池是 `ThreadPoolExecutor`。
  - 如果有空闲线程（少于 `max-threads`，默认 200），直接用。
  - 如果全忙，请求放进队列（`accept-count`，默认 100）。
- **比喻**：
  - 迎宾员喊：“有单子！”服务员队里空闲的人（线程）跑过来接。

#### (3) 线程处理请求
- **怎么做**：
  - 挑中的线程从连接里读数据（HTTP 请求头、正文）。
  - 解析请求（比如 URL 是 `/api/hello`，方法是 GET）。
  - 调用你的代码（比如 Spring 的 Controller）。
- **细节**：
  - 线程跑去执行 `@GetMapping("/hello")` 的方法。
  - 比如：
    ```java
    @RestController
    public class HelloController {
        @GetMapping("/hello")
        public String sayHello() {
            return "Hello World";
        }
    }
    ```
- **比喻**：
  - 服务员拿到订单（请求），跑去厨房（Controller）做菜（执行代码）。

#### (4) 返回响应
- **怎么做**：
  - 线程拿到结果（比如 "Hello World"），通过连接写回客户端。
  - 写完后，线程回线程池待命。
- **细节**：
  - HTTP 响应（状态码 200，内容 "Hello World"）发回浏览器。
  - 线程状态从“忙”变“闲”，准备接新请求。
- **比喻**：
  - 服务员端菜给客人（返回响应），然后回去待命。

#### (5) 特殊情况：线程不够
- **全忙**：
  - 200 个线程（`max-threads`）全在干活，新请求进队列。
- **队列满**：
  - 队列（100 个）也满了，Tomcat 拒绝请求，返回 503。
- **比喻**：
  - 服务员全忙，门口队伍挤满，新客被赶走。

---

### 3. 线程池的关键参数
- **核心线程（min-spare-threads）**：
  - 平时待命的最少服务员，默认 10。
- **最大线程（max-threads）**：
  - 最多服务员数，默认 200。
- **队列（accept-count）**：
  - 排队上限，默认 100。
- **工作逻辑**：
  - 请求 < 核心线程：用空闲线程。
  - 核心线程 < 请求 < 最大线程：加线程。
  - 请求 > 最大线程：排队。
  - 队列满：拒绝。

---

### 4. 图解流程
```
客户端请求 --> [8080 端口] --> [Acceptor 接收]
                |
                v
          [线程池调度]
                |
    +-----------+-----------+
    |                       |
[空闲线程]            [队列排队]
    |                       |
[处理请求]           [线程全忙 --> 队列满 --> 503]
    |
[返回响应]
    |
[线程回池]
```

---

### 5. 通俗总结
- **Tomcat 线程池咋接请求**：
  - **门口迎宾**（Acceptor）收请求。
  - **扔给服务员**（线程池挑线程）。
  - **服务员干活**（执行代码）。
  - **端菜回去**（返回响应，回池）。
- **比喻**：
  - 饭店接到订单，服务员队派人干活，忙完回来待命，忙不过来就排队或谢客。

---