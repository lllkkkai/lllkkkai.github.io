---
layout: post
title: 系统架构设计
---
假设高并发是线上系统的现状，为了保证可用，需要设计一个支持高可用、高性能、可扩展的系统；

1、高性能：性能体现了系统的并行处理能力，在有限的硬件投入下，提高性能意味着节省成本。同时，性能也反映了用户体验，响应时间分别是100毫秒和1秒，给用户的感受是完全不同的。

2、高可用：表示系统可以正常服务的时间。一个全年不停机、无故障；另一个隔三差五出线上事故、宕机，用户肯定选择前者。另外，如果系统只能做到90%可用，也会大大拖累业务。

3、高扩展：表示系统的扩展能力，流量高峰时能否在短时间内完成扩容，更平稳地承接峰值流量，比如双11活动、明星离婚等热点事件。
<!--more-->


## 如何设计可扩展的系统

### **1. 明确扩展性维度（先定义问题）**
- **横向扩展（Scale Out）**：通过增加机器分散负载（如无状态服务）  
- **纵向扩展（Scale Up）**：提升单机性能（如数据库分片）  
- **功能扩展**：通过模块化支持新业务快速接入  

**举例**：  
> "在DSP系统中，竞价服务需要横向扩展应对流量峰值，而用户画像服务可能需要纵向扩展处理大数据计算。"

---

### **2. 分层架构设计（核心方法论）**
```plaintext
┌─────────────────┐
│   客户端层       │ ← CDN/负载均衡（Nginx）
└────────┬────────┘
         ↓
┌─────────────────┐
│   接入层         │ ← API网关（Spring Cloud Gateway）
│   - 限流熔断     │ ← Sentinel
│   - 鉴权         │ ← JWT/OAuth2
└────────┬────────┘
         ↓
┌─────────────────┐
│   业务逻辑层     │ ← 微服务（Spring Cloud）
│   - 竞价服务     │ ← 无状态设计+K8s动态扩缩容
│   - 数据服务     │ ← CQRS模式分离读写
└────────┬────────┘
         ↓
┌─────────────────┐
│   数据层         │ 
│   - 实时数据     │ ← Redis集群+分片
│   - 离线数据     │ ← Hadoop/Spark
└─────────────────┘
```

**关键点**：  
- **无状态化**：Session存储到Redis，服务可任意扩容  
- **异步化**：MQ解耦核心链路（如Kafka处理点击日志）  
- **缓存分级**：本地缓存（Caffeine）+分布式缓存（Redis）  

---

### **3. 扩展性关键技术选型**
| 场景                | 技术方案                          | DSP场景示例                     |
|---------------------|-----------------------------------|--------------------------------|
| 高并发读写          | 数据库分库分表（ShardingSphere）  | 广告订单按广告主ID分片         |
| 实时计算            | Flink窗口计算                     | 实时CTR预估模型更新            |
| 配置动态调整        | Nacos配置中心                     | 竞价算法参数热更新             |
| 全局唯一ID          | 雪花算法（Snowflake）             | 生成竞价请求ID                 |

---

### **4. 可扩展性设计原则**
- **SOLID原则**：特别是接口隔离（如拆分出BiddingService/ReportingService）  
- **防腐层（Anti-Corruption Layer）**：隔离第三方API变更影响  
- **领域驱动设计（DDD）**：通过限界上下文划分微服务边界  

**反例警示**：  
> "我曾见过一个系统将用户画像和竞价逻辑耦合在同一个服务，导致无法单独扩展画像计算资源，后来我们通过DDD重构解耦。"

---

### **5. 实战案例模板**
```plaintext
[项目背景]：XX广告平台日均请求量从10万增长到1亿  
[问题]：原有单体架构导致扩容成本高，竞价延迟飙升  
[解决方案]：  
1. 服务拆分：按业务域拆分为竞价/风控/计费微服务
2. 数据分片：MySQL按广告位ID分库+Redis集群
3. 流量控制：网关层实现基于QPS的动态熔断  
[效果]：TPS从500提升到2万，扩容时间从小时级降到分钟级
```

---

### **6. 高频追问应对**
- **Q：如何避免过度设计？**  
  → "先通过MVP验证核心链路，用指标（如RT/QPS）驱动架构演进，例如我们初期只用Redis分片，后期才引入Elasticsearch做检索。"  

- **Q：微服务拆分过细怎么办？**  
  → "通过SLA分级，核心服务（如竞价）独立部署，非核心服务（如日志）合并部署，并用K8s Namespace隔离。"

---

### **总结回答结构**
1. **分层设计**：展示清晰的架构层次  
2. **技术匹配**：结合DSP业务特点选型  
3. **数据说话**：用性能指标证明设计有效性  
4. **反思能力**：说明权衡取舍的思考过程  

## 如何设计高可用的系统

### **1. 服务的可用性（核心方法论）**